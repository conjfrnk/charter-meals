{% extends "layout.html" %}
{% block content %}
<h2>Welcome to Charter!!</h2>
<p>We can't wait to see you at Charter meals!</p>
<p>
  Sign up below so we have a sense of how many people are coming to each meal.
  Contact our kitchen managers, Tiffany and Hector, if you have any questions.
</p>

{% if not eligible_for_pub %}
  <div style="color: red; font-weight: bold; margin-bottom: 1em;">
    You already signed up for a pub night last week! You can try again next week!
  </div>
{% endif %}

<div id="rules">
  <h3>Rules for Meal Sign-Up</h3>
  <ul>
    <li>You can sign up for a maximum of 2 meals per week (pub nights count as one meal).</li>
    <li>In order to give everyone a chance to attend pub night, you may select at most 1 pub night (dinner of Tuesday or Thursday).</li>
    <li>Again for the sake of fairness, if you attended a pub night last week, you cannot sign up for one this week (i.e. you can only sign up for a pub night every two weeks).</li>
    <li>If a meal time is full or otherwise ineligible, the checkbox will not appear.</li>
  </ul>
</div>

<!-- Your current meal signups for this week -->
<h3>Your Meal Signups for This Week</h3>
{% if current_meals %}
  <ul>
    {% for meal in current_meals %}
      <li>{{ meal.date }} - {{ meal.meal_type|capitalize }}{% if meal.meal_type|lower == "dinner" and (meal.date|weekday in [1,3]) %} (pub night){% endif %}</li>
    {% endfor %}
  </ul>
{% else %}
  <p>You have not signed up for any meals for this week.</p>
{% endif %}

<!-- Next week meal signups -->
<h3>Meal Options for Next Week</h3>
<form id="mealForm" method="POST" action="{{ url_for('reserve') }}" role="form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" id="client_timestamp" name="client_timestamp" value="">
  
  {% for day, slots in slots_by_date|dictsort %}
    <h4>{{ day }} ({{ day|dayname }})</h4>
    <ul>
      {% for slot in slots %}
        {% set is_pub = (slot.meal_type|lower == 'dinner' and slot.date|weekday in [1,3]) %}
        {% set full = (slot_counts[slot.id|string] >= slot.capacity) %}
        {% set ineligible = full or (is_pub and not eligible_for_pub) %}
        <li>
          <label for="slot-{{ slot.id }}">
            {% if ineligible %}
              <input type="checkbox" id="slot-{{ slot.id }}" name="meal_slot" value="{{ slot.id }}" disabled data-original-disabled="true">
            {% else %}
              <input type="checkbox" id="slot-{{ slot.id }}" name="meal_slot" value="{{ slot.id }}"
                     data-pub="{{ 1 if is_pub else 0 }}"
                     data-capacity="{{ slot.capacity }}"
                     aria-describedby="count-{{ slot.id }}"
                     {% if slot.id|string in user_reservations %} checked {% endif %}>
            {% endif %}
            {{ slot.meal_type|capitalize }}{% if is_pub %} (pub night){% endif %}
          </label>
          - <span id="count-{{ slot.id }}" data-capacity="{{ slot.capacity }}">
              {{ slot_counts[slot.id|string] if slot_counts[slot.id|string] is defined else 0 }}/{{ slot.capacity }} reservations
            </span>
        </li>
      {% endfor %}
    </ul>
  {% endfor %}
  
  {% if session["netid"] == "guest" %}
    <p style="color: red; font-weight: bold;">Guest users cannot submit reservations.</p>
    <button type="submit" disabled>Submit Reservations</button>
  {% else %}
    <button type="submit">Submit Reservations</button>
  {% endif %}
</form>

<div class="mobile-spacer"></div>
{% endblock %}

