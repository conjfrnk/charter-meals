{% extends "layout.html" %}
{% block content %}
<h2>Welcome to Charter!!</h2>
<p>We can't wait to see you at Charter meals!</p>
<p>
  Sign up below so we have a sense of how many people are coming to each meal.
  Contact our kitchen managers, Tiffany and Hector, if you have any questions.
</p>

<div id="rules">
  <h3>Rules for Meal Sign-Up</h3>
  <ul>
    <li>You can sign up for a maximum of 2 meals per week (pub nights count as one meal).</li>
    <li>In order to give everyone a chance to attend pub night, you may select at most 1 pub night (dinner of Tuesday or Thursday).</li>
    <li>Again for the sake of fairness, if you attended a pub night last week, you cannot sign up for one this week (i.e. you can only sign up for a pub night every two weeks).</li>
    <li>If a meal time is full or otherwise ineligible, the checkbox will not appear.</li>
  </ul>
</div>

<!-- Display current week's signups -->
<h3>Your Meal Signups for This Week</h3>
{% if current_meals %}
  <ul>
    {% for meal in current_meals %}
      <li>{{ meal.date }} - {{ meal.meal_type|capitalize }}{% if meal.meal_type|lower == "dinner" and (meal.date|weekday in [1,3]) %} (pub night){% endif %}</li>
    {% endfor %}
  </ul>
{% else %}
  <p>You have not signed up for any meals for this week.</p>
{% endif %}

{% if signup_open %}
  <!-- When signups are open -->
  <h3>Meal Options for Next Week</h3>
  <!-- Display banner if the user has been manually added to a pub night -->
  {% if manual_pub_info %}
    <div class="banner">
      You have been added to pub night on {{ manual_pub_info.date|dayname }} {{ manual_pub_info.date }} by {{ manual_pub_info.added_by }}.
      You may only select one more meal for this week.
    </div>
  {% endif %}
  <!-- Set data-max-meals: if manual pub exists then 1, else 2 -->
  <form id="mealForm" method="POST" action="{{ url_for('reserve') }}" role="form" data-max-meals="{{ 1 if manual_pub_info else 2 }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" id="client_timestamp" name="client_timestamp" value="">
    {% for day, slots in slots_by_date|dictsort %}
      <h4>{{ day }} ({{ day|dayname }})</h4>
      <ul>
        {% for slot in slots %}
          {% set is_pub = (slot.meal_type|lower == 'dinner' and slot.date|weekday in [1,3]) %}
          {% set full = (slot_counts[slot.id|string] >= slot.capacity) %}
          <li>
            <label for="slot-{{ slot.id }}">
              {# 
                 If the slot is full OR (it is a pub night slot and the user already has a pub night reservation
                 or current pub night registration) AND this slot is not already reserved by the user,
                 then disable it. Otherwise, render it normally (and check it if the user has reserved it).
              #}
              {% if full or (is_pub and (user_has_pub_selected or user_has_pub_current) and (slot.id|string not in user_reservations)) %}
                <input type="checkbox" id="slot-{{ slot.id }}" name="meal_slot" value="{{ slot.id }}" disabled class="perma-disabled">
              {% else %}
                <input type="checkbox" id="slot-{{ slot.id }}" name="meal_slot" value="{{ slot.id }}"
                       data-pub="{{ 1 if is_pub else 0 }}"
                       data-capacity="{{ slot.capacity }}"
                       {% if slot.id|string in user_reservations %} checked {% endif %}>
              {% endif %}
              {{ slot.meal_type|capitalize }}{% if is_pub %} (pub night){% endif %}
            </label>
            - <span id="count-{{ slot.id }}" data-capacity="{{ slot.capacity }}">
                {{ slot_counts[slot.id|string] if slot_counts[slot.id|string] is defined else 0 }}/{{ slot.capacity }} reservations
              </span>
          </li>
        {% endfor %}
      </ul>
    {% endfor %}
    {% if session["netid"] == "guest" %}
      <p class="error-message">Guest users cannot submit reservations.</p>
    {% else %}
      <button type="submit">Submit Reservations</button>
    {% endif %}
    <br>
    <br>
    <br>
  </form>
{% else %}
  <!-- When signups are closed -->
  <h3 class="banner"><span class="highlight">Meal Signups are Currently Closed</span></h3>
  <div id="signup-info" class="banner-info">
    {% if meal_period_start and meal_period_end and next_signup_open and next_signup_close %}
      <p>
         Meal signups for {{ meal_period_start.strftime("%A, %B %d, %Y") }} â€“ {{ meal_period_end.strftime("%A, %B %d, %Y") }}
         will open on <span class="highlight">{{ next_signup_open.strftime("%A, %B %d, %Y at %I:%M %p") }}</span> US Eastern.
         Signups will close on <span class="highlight">{{ next_signup_close.strftime("%A, %B %d, %Y at %I:%M %p") }}</span> US Eastern.
      </p>
      <br>
      <br>
      <br>
    {% else %}
      <p>Meal signups opening information is not available.</p>
      <br>
      <br>
      <br>
    {% endif %}
  </div>
{% endif %}
{% endblock %}
